// ---------------------------------------------------------------------------
// Pegasus — Prisma Schema
// Translates the domain bounded contexts into PostgreSQL tables.
//
// Two PostgreSQL schemas are used:
//   public   — all tenant-facing tables (@@schema("public") on every model/enum)
//   platform — platform/admin-only tables; never queried by tenant APIs
// ---------------------------------------------------------------------------

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuidOssp(map: "uuid-ossp")]
  schemas    = ["public", "platform"]
}

// ---------------------------------------------------------------------------
// Enums — public schema
// ---------------------------------------------------------------------------

enum MoveStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@schema("public")
}

enum StopType {
  PICKUP
  DELIVERY
  STORAGE
  WAYPOINT

  @@schema("public")
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED

  @@schema("public")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PARTIALLY_PAID
  PAID
  VOID

  @@schema("public")
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  CASH
  CHECK

  @@schema("public")
}

enum ItemCondition {
  EXCELLENT
  GOOD
  FAIR
  DAMAGED
  MISSING

  @@schema("public")
}

enum CrewRole {
  DRIVER
  MOVER
  SUPERVISOR

  @@schema("public")
}

/// Lifecycle status of a tenant account, managed by platform administrators.
enum TenantStatus {
  /// Fully operational — tenant users can access the API.
  ACTIVE
  /// Access suspended — tenant middleware returns 403 for this tenant.
  SUSPENDED
  /// Soft-deleted — tenant middleware returns 404; excluded from admin list by default.
  OFFBOARDED

  @@schema("public")
}

/// Subscription plan tier for a tenant account.
enum TenantPlan {
  STARTER
  GROWTH
  ENTERPRISE

  @@schema("public")
}

// ---------------------------------------------------------------------------
// Multi-tenancy — Tenant is the root of every bounded context.
// Each moving-company instance is one Tenant. The slug is the subdomain
// identifier (e.g. "acme" in acme.pegasusapp.com).
// ---------------------------------------------------------------------------

model Tenant {
  id   String @id @default(uuid())
  name String
  slug String @unique

  // -------------------------------------------------------------------------
  // Admin-managed fields (written only by platform admin routes)
  // -------------------------------------------------------------------------

  /// Current lifecycle status. The tenant middleware enforces this:
  /// SUSPENDED → 403, OFFBOARDED → 404, ACTIVE → normal flow.
  status TenantStatus @default(ACTIVE)

  /// Subscription plan tier. Used for feature gating (future).
  plan TenantPlan @default(STARTER)

  /// Primary contact name for this tenant account (billing/support contact).
  contactName String? @map("contact_name")

  /// Primary contact email for this tenant account.
  contactEmail String? @map("contact_email")

  /// Stub for future per-tenant SSO / organisational login configuration.
  /// Will hold provider type, client IDs, and metadata when implemented.
  ssoProviderConfig Json? @map("sso_provider_config")

  /// Set when the tenant is offboarded. Data is retained; the tenant is
  /// excluded from all default queries. Null means not offboarded.
  deletedAt DateTime? @map("deleted_at")

  // -------------------------------------------------------------------------
  // Relations
  // -------------------------------------------------------------------------

  customers      Customer[]
  moves          Move[]
  quotes         Quote[]
  invoices       Invoice[]
  crewMembers    CrewMember[]
  vehicles       Vehicle[]
  availabilities Availability[]
  inventoryRooms InventoryRoom[]
  leadSources    LeadSource[]
  accounts       Account[]
  rateTables     RateTable[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([deletedAt])
  @@schema("public")
  @@map("tenants")
}

// ---------------------------------------------------------------------------
// Customer context
// ---------------------------------------------------------------------------

model LeadSource {
  id          String @id @default(uuid())
  tenantId    String @map("tenant_id")
  name        String
  description String?

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  customers Customer[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@schema("public")
  @@map("lead_sources")
}

model Account {
  id       String @id @default(uuid())
  tenantId String @map("tenant_id")
  name     String

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  customers Customer[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@schema("public")
  @@map("accounts")
}

model Customer {
  id           String  @id @default(uuid())
  tenantId     String  @map("tenant_id")
  userId       String  @map("user_id")
  accountId    String? @map("account_id")
  leadSourceId String? @map("lead_source_id")
  firstName    String  @map("first_name")
  lastName     String  @map("last_name")
  email        String
  phone        String?

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  account    Account?    @relation(fields: [accountId], references: [id])
  leadSource LeadSource? @relation(fields: [leadSourceId], references: [id])
  contacts   Contact[]
  moves      Move[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([userId])
  @@schema("public")
  @@map("customers")
}

model Contact {
  id         String  @id @default(uuid())
  customerId String  @map("customer_id")
  firstName  String  @map("first_name")
  lastName   String  @map("last_name")
  email      String
  phone      String?
  isPrimary  Boolean @default(false) @map("is_primary")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([customerId])
  @@schema("public")
  @@map("contacts")
}

// ---------------------------------------------------------------------------
// Shared — Address value object persisted as its own table
// ---------------------------------------------------------------------------

model Address {
  id         String  @id @default(uuid())
  line1      String
  line2      String?
  city       String
  state      String
  postalCode String  @map("postal_code")
  country    String

  originMoves      Move[] @relation("MoveOrigin")
  destinationMoves Move[] @relation("MoveDestination")
  stops            Stop[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@schema("public")
  @@map("addresses")
}

// ---------------------------------------------------------------------------
// Dispatch context
// ---------------------------------------------------------------------------

model Move {
  id            String     @id @default(uuid())
  tenantId      String     @map("tenant_id")
  userId        String     @map("user_id")
  customerId    String?    @map("customer_id")
  status        MoveStatus @default(PENDING)
  originId      String     @map("origin_id")
  destinationId String     @map("destination_id")
  scheduledDate DateTime   @map("scheduled_date")

  tenant             Tenant                  @relation(fields: [tenantId], references: [id])
  customer           Customer?               @relation(fields: [customerId], references: [id])
  origin             Address                 @relation("MoveOrigin", fields: [originId], references: [id])
  destination        Address                 @relation("MoveDestination", fields: [destinationId], references: [id])
  stops              Stop[]
  crewAssignments    MoveCrewAssignment[]
  vehicleAssignments MoveVehicleAssignment[]
  quotes             Quote[]
  invoices           Invoice[]
  inventoryRooms     InventoryRoom[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([userId])
  @@index([customerId])
  @@index([status])
  @@index([scheduledDate])
  @@schema("public")
  @@map("moves")
}

model Stop {
  id          String    @id @default(uuid())
  moveId      String    @map("move_id")
  type        StopType
  addressId   String    @map("address_id")
  sequence    Int
  scheduledAt DateTime? @map("scheduled_at")
  arrivedAt   DateTime? @map("arrived_at")
  departedAt  DateTime? @map("departed_at")
  notes       String?

  move    Move    @relation(fields: [moveId], references: [id], onDelete: Cascade)
  address Address @relation(fields: [addressId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([moveId])
  @@schema("public")
  @@map("stops")
}

// ---------------------------------------------------------------------------
// Schedule context
// ---------------------------------------------------------------------------

model CrewMember {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  name           String
  role           CrewRole
  licenceClasses String[] @map("licence_classes")
  isActive       Boolean  @default(true) @map("is_active")

  tenant          Tenant               @relation(fields: [tenantId], references: [id])
  moveAssignments MoveCrewAssignment[]
  availabilities  Availability[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@schema("public")
  @@map("crew_members")
}

model Vehicle {
  id                 String   @id @default(uuid())
  tenantId           String   @map("tenant_id")
  registrationPlate  String   @map("registration_plate")
  make               String
  model              String
  capacityCubicFeet  Float    @map("capacity_cubic_feet")
  lastInspectionDate DateTime @map("last_inspection_date")
  isActive           Boolean  @default(true) @map("is_active")

  tenant          Tenant                  @relation(fields: [tenantId], references: [id])
  moveAssignments MoveVehicleAssignment[]
  availabilities  Availability[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, registrationPlate])
  @@index([tenantId])
  @@schema("public")
  @@map("vehicles")
}

model Availability {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  crewMemberId String?  @map("crew_member_id")
  vehicleId    String?  @map("vehicle_id")
  windowStart  DateTime @map("window_start")
  windowEnd    DateTime @map("window_end")
  isAvailable  Boolean  @default(true) @map("is_available")

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  crewMember CrewMember? @relation(fields: [crewMemberId], references: [id])
  vehicle    Vehicle?    @relation(fields: [vehicleId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([crewMemberId])
  @@index([vehicleId])
  @@index([windowStart, windowEnd])
  @@schema("public")
  @@map("availabilities")
}

model MoveCrewAssignment {
  moveId       String   @map("move_id")
  crewMemberId String   @map("crew_member_id")
  assignedAt   DateTime @default(now()) @map("assigned_at")

  move       Move       @relation(fields: [moveId], references: [id], onDelete: Cascade)
  crewMember CrewMember @relation(fields: [crewMemberId], references: [id])

  @@id([moveId, crewMemberId])
  @@schema("public")
  @@map("move_crew_assignments")
}

model MoveVehicleAssignment {
  moveId     String   @map("move_id")
  vehicleId  String   @map("vehicle_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  move    Move    @relation(fields: [moveId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id])

  @@id([moveId, vehicleId])
  @@schema("public")
  @@map("move_vehicle_assignments")
}

// ---------------------------------------------------------------------------
// Quoting context
// ---------------------------------------------------------------------------

model RateTable {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  name          String
  effectiveFrom DateTime  @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")
  isActive      Boolean   @default(false) @map("is_active")

  tenant Tenant  @relation(fields: [tenantId], references: [id])
  rates  Rate[]
  quotes Quote[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@schema("public")
  @@map("rate_tables")
}

model Rate {
  id          String  @id @default(uuid())
  rateTableId String  @map("rate_table_id")
  serviceCode String  @map("service_code")
  description String
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  currency    String  @default("USD")

  rateTable RateTable @relation(fields: [rateTableId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([rateTableId])
  @@unique([rateTableId, serviceCode])
  @@schema("public")
  @@map("rates")
}

model Quote {
  id            String      @id @default(uuid())
  tenantId      String      @map("tenant_id")
  moveId        String      @map("move_id")
  rateTableId   String?     @map("rate_table_id")
  status        QuoteStatus @default(DRAFT)
  priceAmount   Decimal     @map("price_amount") @db.Decimal(12, 2)
  priceCurrency String      @default("USD") @map("price_currency")
  validUntil    DateTime    @map("valid_until")

  tenant    Tenant          @relation(fields: [tenantId], references: [id])
  move      Move            @relation(fields: [moveId], references: [id])
  rateTable RateTable?      @relation(fields: [rateTableId], references: [id])
  lineItems QuoteLineItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([moveId])
  @@index([status])
  @@schema("public")
  @@map("quotes")
}

model QuoteLineItem {
  id          String  @id @default(uuid())
  quoteId     String  @map("quote_id")
  description String
  quantity    Int
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  currency    String  @default("USD")

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([quoteId])
  @@schema("public")
  @@map("quote_line_items")
}

// ---------------------------------------------------------------------------
// Inventory context
// ---------------------------------------------------------------------------

model InventoryRoom {
  id       String @id @default(uuid())
  tenantId String @map("tenant_id")
  moveId   String @map("move_id")
  name     String

  tenant Tenant          @relation(fields: [tenantId], references: [id])
  move   Move            @relation(fields: [moveId], references: [id], onDelete: Cascade)
  items  InventoryItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([moveId])
  @@schema("public")
  @@map("inventory_rooms")
}

model InventoryItem {
  id                    String         @id @default(uuid())
  roomId                String         @map("room_id")
  name                  String
  description           String?
  quantity              Int            @default(1)
  declaredValue         Decimal?       @map("declared_value") @db.Decimal(12, 2)
  declaredValueCurrency String?        @default("USD") @map("declared_value_currency")
  conditionAtPack       ItemCondition? @map("condition_at_pack")
  conditionAtDelivery   ItemCondition? @map("condition_at_delivery")

  room InventoryRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([roomId])
  @@schema("public")
  @@map("inventory_items")
}

// ---------------------------------------------------------------------------
// Billing context
// ---------------------------------------------------------------------------

model Invoice {
  id            String        @id @default(uuid())
  tenantId      String        @map("tenant_id")
  moveId        String        @map("move_id")
  quoteId       String?       @unique @map("quote_id")
  status        InvoiceStatus @default(DRAFT)
  totalAmount   Decimal       @map("total_amount") @db.Decimal(12, 2)
  totalCurrency String        @default("USD") @map("total_currency")
  issuedAt      DateTime?     @map("issued_at")
  dueAt         DateTime?     @map("due_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  move     Move      @relation(fields: [moveId], references: [id])
  payments Payment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([moveId])
  @@index([status])
  @@schema("public")
  @@map("invoices")
}

model Payment {
  id        String        @id @default(uuid())
  invoiceId String        @map("invoice_id")
  amount    Decimal       @db.Decimal(12, 2)
  currency  String        @default("USD")
  method    PaymentMethod
  paidAt    DateTime      @map("paid_at")
  reference String?

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([invoiceId])
  @@schema("public")
  @@map("payments")
}

// ---------------------------------------------------------------------------
// Platform schema — admin-only tables
//
// These models live in the `platform` PostgreSQL schema. They are never
// queried by tenant-facing API routes or the tenant-scoped Prisma extension.
// The platform schema is not accessible to TENANT_USER-scoped requests.
// ---------------------------------------------------------------------------

/// Tracks Cognito users who have been granted platform administrator access.
/// A record is upserted on first successful admin portal sign-in using the
/// Cognito sub claim as the stable identifier.
model AdminUser {
  id          String  @id @default(uuid())
  /// Stable Cognito user identifier (JWT `sub` claim). Never changes even if
  /// the user updates their email address.
  cognitoSub  String  @unique @map("cognito_sub")
  email       String  @unique
  displayName String? @map("display_name")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@schema("platform")
  @@map("admin_users")
}

/// Append-only audit trail for every action taken by a platform administrator.
///
/// `before` and `after` capture JSON snapshots of the affected resource so the
/// full change history can be reconstructed. Neither field is set for the
/// irrelevant side (before=null on create, after=null on hard delete).
model AuditLog {
  id           String   @id @default(uuid())
  /// Cognito sub of the administrator who performed the action.
  adminSub     String   @map("admin_sub")
  /// Denormalised email for display — avoids joins when rendering the log.
  adminEmail   String   @map("admin_email")
  /// Action identifier. Values: CREATE_TENANT | UPDATE_TENANT |
  /// SUSPEND_TENANT | REACTIVATE_TENANT | OFFBOARD_TENANT
  action       String
  /// Type of the affected resource. Currently always "TENANT".
  resourceType String   @map("resource_type")
  /// ID of the affected resource.
  resourceId   String   @map("resource_id")
  /// Snapshot of the resource before the mutation (null for creates).
  before       Json?
  /// Snapshot of the resource after the mutation (null for hard deletes).
  after        Json?
  ipAddress    String?  @map("ip_address")
  userAgent    String?  @map("user_agent")
  /// No updatedAt — audit logs are immutable once written.
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([resourceId])
  @@index([adminSub])
  @@index([createdAt])
  @@schema("platform")
  @@map("audit_logs")
}

/// Platform-level feature flags for gradual rollout of new capabilities.
/// Not yet surfaced in the admin UI — stub for future use.
model FeatureFlag {
  id          String  @id @default(uuid())
  name        String  @unique
  enabled     Boolean @default(false)
  description String?

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@schema("platform")
  @@map("feature_flags")
}
