// ---------------------------------------------------------------------------
// Pegasus — Prisma Schema
// Translates the domain bounded contexts into PostgreSQL tables.
// ---------------------------------------------------------------------------

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  binaryTargets   = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [uuidOssp(map: "uuid-ossp")]
}

// ---------------------------------------------------------------------------
// Enums
// ---------------------------------------------------------------------------

enum MoveStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum StopType {
  PICKUP
  DELIVERY
  STORAGE
  WAYPOINT
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PARTIALLY_PAID
  PAID
  VOID
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  CASH
  CHECK
}

enum ItemCondition {
  EXCELLENT
  GOOD
  FAIR
  DAMAGED
  MISSING
}

enum CrewRole {
  DRIVER
  MOVER
  SUPERVISOR
}

// ---------------------------------------------------------------------------
// Multi-tenancy — Tenant is the root of every bounded context.
// Each moving-company instance is one Tenant. The slug is the subdomain
// identifier (e.g. "acme" in acme.pegasusapp.com).
// ---------------------------------------------------------------------------

model Tenant {
  id   String @id @default(uuid())
  name String
  slug String @unique

  customers      Customer[]
  moves          Move[]
  quotes         Quote[]
  invoices       Invoice[]
  crewMembers    CrewMember[]
  vehicles       Vehicle[]
  availabilities Availability[]
  inventoryRooms InventoryRoom[]
  leadSources    LeadSource[]
  accounts       Account[]
  rateTables     RateTable[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("tenants")
}

// ---------------------------------------------------------------------------
// Customer context
// ---------------------------------------------------------------------------

model LeadSource {
  id          String @id @default(uuid())
  tenantId    String @map("tenant_id")
  name        String
  description String?

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  customers Customer[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("lead_sources")
}

model Account {
  id       String @id @default(uuid())
  tenantId String @map("tenant_id")
  name     String

  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  customers Customer[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("accounts")
}

model Customer {
  id           String  @id @default(uuid())
  tenantId     String  @map("tenant_id")
  userId       String  @map("user_id")
  accountId    String? @map("account_id")
  leadSourceId String? @map("lead_source_id")
  firstName    String  @map("first_name")
  lastName     String  @map("last_name")
  email        String
  phone        String?

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  account    Account?    @relation(fields: [accountId], references: [id])
  leadSource LeadSource? @relation(fields: [leadSourceId], references: [id])
  contacts   Contact[]
  moves      Move[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([userId])
  @@map("customers")
}

model Contact {
  id         String  @id @default(uuid())
  customerId String  @map("customer_id")
  firstName  String  @map("first_name")
  lastName   String  @map("last_name")
  email      String
  phone      String?
  isPrimary  Boolean @default(false) @map("is_primary")

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([customerId])
  @@map("contacts")
}

// ---------------------------------------------------------------------------
// Shared — Address value object persisted as its own table
// ---------------------------------------------------------------------------

model Address {
  id         String  @id @default(uuid())
  line1      String
  line2      String?
  city       String
  state      String
  postalCode String  @map("postal_code")
  country    String

  originMoves      Move[] @relation("MoveOrigin")
  destinationMoves Move[] @relation("MoveDestination")
  stops            Stop[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("addresses")
}

// ---------------------------------------------------------------------------
// Dispatch context
// ---------------------------------------------------------------------------

model Move {
  id            String     @id @default(uuid())
  tenantId      String     @map("tenant_id")
  userId        String     @map("user_id")
  customerId    String?    @map("customer_id")
  status        MoveStatus @default(PENDING)
  originId      String     @map("origin_id")
  destinationId String     @map("destination_id")
  scheduledDate DateTime   @map("scheduled_date")

  tenant             Tenant                  @relation(fields: [tenantId], references: [id])
  customer           Customer?               @relation(fields: [customerId], references: [id])
  origin             Address                 @relation("MoveOrigin", fields: [originId], references: [id])
  destination        Address                 @relation("MoveDestination", fields: [destinationId], references: [id])
  stops              Stop[]
  crewAssignments    MoveCrewAssignment[]
  vehicleAssignments MoveVehicleAssignment[]
  quotes             Quote[]
  invoices           Invoice[]
  inventoryRooms     InventoryRoom[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([userId])
  @@index([customerId])
  @@index([status])
  @@index([scheduledDate])
  @@map("moves")
}

model Stop {
  id          String    @id @default(uuid())
  moveId      String    @map("move_id")
  type        StopType
  addressId   String    @map("address_id")
  sequence    Int
  scheduledAt DateTime? @map("scheduled_at")
  arrivedAt   DateTime? @map("arrived_at")
  departedAt  DateTime? @map("departed_at")
  notes       String?

  move    Move    @relation(fields: [moveId], references: [id], onDelete: Cascade)
  address Address @relation(fields: [addressId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([moveId])
  @@map("stops")
}

// ---------------------------------------------------------------------------
// Schedule context
// ---------------------------------------------------------------------------

model CrewMember {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  name           String
  role           CrewRole
  licenceClasses String[] @map("licence_classes")
  isActive       Boolean  @default(true) @map("is_active")

  tenant          Tenant               @relation(fields: [tenantId], references: [id])
  moveAssignments MoveCrewAssignment[]
  availabilities  Availability[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@map("crew_members")
}

model Vehicle {
  id                 String   @id @default(uuid())
  tenantId           String   @map("tenant_id")
  registrationPlate  String   @map("registration_plate")
  make               String
  model              String
  capacityCubicFeet  Float    @map("capacity_cubic_feet")
  lastInspectionDate DateTime @map("last_inspection_date")
  isActive           Boolean  @default(true) @map("is_active")

  tenant          Tenant                  @relation(fields: [tenantId], references: [id])
  moveAssignments MoveVehicleAssignment[]
  availabilities  Availability[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, registrationPlate])
  @@index([tenantId])
  @@map("vehicles")
}

model Availability {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  crewMemberId String?  @map("crew_member_id")
  vehicleId    String?  @map("vehicle_id")
  windowStart  DateTime @map("window_start")
  windowEnd    DateTime @map("window_end")
  isAvailable  Boolean  @default(true) @map("is_available")

  tenant     Tenant      @relation(fields: [tenantId], references: [id])
  crewMember CrewMember? @relation(fields: [crewMemberId], references: [id])
  vehicle    Vehicle?    @relation(fields: [vehicleId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([crewMemberId])
  @@index([vehicleId])
  @@index([windowStart, windowEnd])
  @@map("availabilities")
}

model MoveCrewAssignment {
  moveId       String   @map("move_id")
  crewMemberId String   @map("crew_member_id")
  assignedAt   DateTime @default(now()) @map("assigned_at")

  move       Move       @relation(fields: [moveId], references: [id], onDelete: Cascade)
  crewMember CrewMember @relation(fields: [crewMemberId], references: [id])

  @@id([moveId, crewMemberId])
  @@map("move_crew_assignments")
}

model MoveVehicleAssignment {
  moveId     String   @map("move_id")
  vehicleId  String   @map("vehicle_id")
  assignedAt DateTime @default(now()) @map("assigned_at")

  move    Move    @relation(fields: [moveId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id])

  @@id([moveId, vehicleId])
  @@map("move_vehicle_assignments")
}

// ---------------------------------------------------------------------------
// Quoting context
// ---------------------------------------------------------------------------

model RateTable {
  id            String    @id @default(uuid())
  tenantId      String    @map("tenant_id")
  name          String
  effectiveFrom DateTime  @map("effective_from")
  effectiveTo   DateTime? @map("effective_to")
  isActive      Boolean   @default(false) @map("is_active")

  tenant Tenant  @relation(fields: [tenantId], references: [id])
  rates  Rate[]
  quotes Quote[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("rate_tables")
}

model Rate {
  id          String  @id @default(uuid())
  rateTableId String  @map("rate_table_id")
  serviceCode String  @map("service_code")
  description String
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  currency    String  @default("USD")

  rateTable RateTable @relation(fields: [rateTableId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([rateTableId])
  @@unique([rateTableId, serviceCode])
  @@map("rates")
}

model Quote {
  id            String      @id @default(uuid())
  tenantId      String      @map("tenant_id")
  moveId        String      @map("move_id")
  rateTableId   String?     @map("rate_table_id")
  status        QuoteStatus @default(DRAFT)
  priceAmount   Decimal     @map("price_amount") @db.Decimal(12, 2)
  priceCurrency String      @default("USD") @map("price_currency")
  validUntil    DateTime    @map("valid_until")

  tenant    Tenant         @relation(fields: [tenantId], references: [id])
  move      Move           @relation(fields: [moveId], references: [id])
  rateTable RateTable?     @relation(fields: [rateTableId], references: [id])
  lineItems QuoteLineItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([moveId])
  @@index([status])
  @@map("quotes")
}

model QuoteLineItem {
  id          String  @id @default(uuid())
  quoteId     String  @map("quote_id")
  description String
  quantity    Int
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  currency    String  @default("USD")

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([quoteId])
  @@map("quote_line_items")
}

// ---------------------------------------------------------------------------
// Inventory context
// ---------------------------------------------------------------------------

model InventoryRoom {
  id       String @id @default(uuid())
  tenantId String @map("tenant_id")
  moveId   String @map("move_id")
  name     String

  tenant Tenant          @relation(fields: [tenantId], references: [id])
  move   Move            @relation(fields: [moveId], references: [id], onDelete: Cascade)
  items  InventoryItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([moveId])
  @@map("inventory_rooms")
}

model InventoryItem {
  id                    String         @id @default(uuid())
  roomId                String         @map("room_id")
  name                  String
  description           String?
  quantity              Int            @default(1)
  declaredValue         Decimal?       @map("declared_value") @db.Decimal(12, 2)
  declaredValueCurrency String?        @default("USD") @map("declared_value_currency")
  conditionAtPack       ItemCondition? @map("condition_at_pack")
  conditionAtDelivery   ItemCondition? @map("condition_at_delivery")

  room InventoryRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([roomId])
  @@map("inventory_items")
}

// ---------------------------------------------------------------------------
// Billing context
// ---------------------------------------------------------------------------

model Invoice {
  id            String        @id @default(uuid())
  tenantId      String        @map("tenant_id")
  moveId        String        @map("move_id")
  quoteId       String?       @unique @map("quote_id")
  status        InvoiceStatus @default(DRAFT)
  totalAmount   Decimal       @map("total_amount") @db.Decimal(12, 2)
  totalCurrency String        @default("USD") @map("total_currency")
  issuedAt      DateTime?     @map("issued_at")
  dueAt         DateTime?     @map("due_at")

  tenant   Tenant    @relation(fields: [tenantId], references: [id])
  move     Move      @relation(fields: [moveId], references: [id])
  payments Payment[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([moveId])
  @@index([status])
  @@map("invoices")
}

model Payment {
  id        String        @id @default(uuid())
  invoiceId String        @map("invoice_id")
  amount    Decimal       @db.Decimal(12, 2)
  currency  String        @default("USD")
  method    PaymentMethod
  paidAt    DateTime      @map("paid_at")
  reference String?

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([invoiceId])
  @@map("payments")
}
